<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PaletteEditor Test - Semitile</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #1a1a2e;
        color: #ffffff;
        padding: 2rem;
        line-height: 1.6;
        margin: 0;
      }

      h1 {
        color: #00ff88;
        border-bottom: 2px solid #00ff88;
        padding-bottom: 0.5rem;
        margin-top: 0;
      }

      h2 {
        color: #00d4ff;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .app-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-top: 1.5rem;
      }

      .panel {
        background: #16213e;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #0f3460;
      }

      .status {
        padding: 0.75rem 1rem;
        border-radius: 4px;
        margin: 1rem 0;
        font-weight: 600;
      }

      .status.loading {
        background: #0f3460;
        color: #00d4ff;
      }

      .status.ready {
        background: #003d2e;
        color: #00ff88;
      }

      .status.error {
        background: #4d0026;
        color: #ff0088;
      }

      .info-text {
        color: #b8b8b8;
        font-size: 0.85rem;
        line-height: 1.4;
        margin: 0.5rem 0;
      }

      button {
        background: #00ff88;
        color: #1a1a2e;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        margin: 0.25rem 0.5rem 0.25rem 0;
      }

      button:hover {
        background: #00cc6a;
      }

      button.secondary {
        background: #16213e;
        color: #00d4ff;
        border: 2px solid #00d4ff;
      }

      button.secondary:hover {
        background: #0f3460;
      }

      .log {
        background: #0a0a0f;
        padding: 1rem;
        border-radius: 4px;
        font-family: "SF Mono", "Courier New", monospace;
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
      }

      .log-entry {
        margin: 0.25rem 0;
        padding: 0.25rem 0;
        border-bottom: 1px solid #16213e;
        color: #00d4ff;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .color-display {
        display: flex;
        gap: 1rem;
        margin: 1rem 0;
        padding: 1rem;
        background: #0a0a0f;
        border-radius: 4px;
      }

      .color-swatch-large {
        width: 100px;
        height: 100px;
        border: 2px solid #0f3460;
        border-radius: 4px;
      }

      .color-info {
        flex: 1;
      }

      .color-info-row {
        margin: 0.5rem 0;
        display: flex;
        justify-content: space-between;
      }

      .color-label {
        color: #b8b8b8;
        font-size: 0.85rem;
      }

      .color-value {
        color: #00ff88;
        font-weight: 600;
        font-family: "SF Mono", "Courier New", monospace;
        font-size: 0.9rem;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0;
      }

      .divider {
        height: 1px;
        background: #0f3460;
        margin: 1rem 0;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <h1>ðŸŽ¨ PaletteEditor Component Test</h1>
      <p class="info-text">
        This demonstrates the PaletteEditor View component and PaletteController
        (Stage 7) following the MVC architecture.
      </p>

      <div id="status" class="status loading">Loading WASM module...</div>

      <div id="test-content" style="display: none">
        <div class="layout">
          <!-- Left Panel: Palette Editor -->
          <div class="panel">
            <h2>Palette Editor View</h2>
            <p class="info-text">
              The PaletteEditor displays colors from the active sub-palette. Click a
              color to select it, or use the dropdown to change sub-palettes.
            </p>

            <palette-editor id="palette-editor"></palette-editor>

            <div class="divider"></div>

            <h2>Selected Color Details</h2>
            <div id="selected-color-display" class="color-display">
              <div id="selected-color-swatch" class="color-swatch-large"></div>
              <div class="color-info">
                <div class="color-info-row">
                  <span class="color-label">Sub-Palette:</span>
                  <span class="color-value" id="info-subpalette">0</span>
                </div>
                <div class="color-info-row">
                  <span class="color-label">Color Index:</span>
                  <span class="color-value" id="info-color-index">0</span>
                </div>
                <div class="color-info-row">
                  <span class="color-label">RGB888:</span>
                  <span class="color-value" id="info-rgb888">0, 0, 0</span>
                </div>
                <div class="color-info-row">
                  <span class="color-label">RGB555:</span>
                  <span class="color-value" id="info-rgb555">0x0000</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Panel: Controls and Log -->
          <div class="panel">
            <h2>Controller API</h2>
            <p class="info-text">
              Test the PaletteController's public API methods.
            </p>

            <div class="controls">
              <button onclick="testSelectColor(0)">Select Color 0</button>
              <button onclick="testSelectColor(5)">Select Color 5</button>
              <button onclick="testSelectColor(15)">Select Color 15</button>
            </div>

            <div class="controls">
              <button class="secondary" onclick="testSubPalette(0)">
                Sub-Palette 0
              </button>
              <button class="secondary" onclick="testSubPalette(1)">
                Sub-Palette 1
              </button>
              <button class="secondary" onclick="testSubPalette(7)">
                Sub-Palette 7
              </button>
            </div>

            <div class="controls">
              <button onclick="randomizePalette()">Randomize Colors</button>
              <button onclick="grayscalePalette()">Grayscale Palette</button>
            </div>

            <div class="divider"></div>

            <h2>Event Log</h2>
            <p class="info-text">
              Events dispatched by the View and handled by the Controller.
            </p>
            <button onclick="clearLog()" class="secondary">Clear Log</button>
            <div id="event-log" class="log"></div>
          </div>
        </div>

        <div class="panel" style="margin-top: 1.5rem">
          <h2>MVC Architecture</h2>
          <p class="info-text">
            <strong>Model (PaletteModel):</strong> Stores 256 colors (16 sub-palettes
            Ã— 16 colors), tracks active sub-palette and selected color, emits events
            on changes.<br /><br />
            <strong>View (PaletteEditor):</strong> Renders color swatches and
            sub-palette selector, listens to Model events and re-renders, dispatches
            custom events for user interactions.<br /><br />
            <strong>Controller (PaletteController):</strong> Wires View to Model,
            handles View events (color-select-clicked, subpalette-change-clicked),
            updates Model which triggers View re-render.<br /><br />
            <strong>Data Flow:</strong> User clicks color â†’ View dispatches event â†’
            Controller updates Model â†’ Model emits event â†’ View re-renders
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      import { initWasm, WasmPalette, WasmColor } from "../lib/wasm-loader.js";
      import { PaletteModel } from "../models/PaletteModel.js";
      import { PaletteEditor } from "../views/PaletteEditor/PaletteEditor.js";
      import { PaletteController } from "../controllers/PaletteController.js";

      let paletteModel, paletteEditor, paletteController;

      // Initialize WASM and set up MVC
      async function init() {
        const statusDiv = document.getElementById("status");
        const testContent = document.getElementById("test-content");

        try {
          await initWasm();
          statusDiv.className = "status ready";
          statusDiv.textContent = "âœ“ Ready - MVC architecture initialized";
          testContent.style.display = "block";

          // Create Model
          paletteModel = new PaletteModel(new WasmPalette());

          // Set up default palette with varied colors
          setupDefaultPalette();

          // Get the View
          paletteEditor = document.getElementById("palette-editor");

          // Create the Controller - this wires everything together!
          paletteController = new PaletteController(paletteModel, paletteEditor);

          // Listen to model events to update the color display
          paletteModel.on("colorSelected", updateSelectedColorDisplay);
          paletteModel.on("subPaletteChanged", updateSelectedColorDisplay);
          paletteModel.on("colorChanged", updateSelectedColorDisplay);

          // Make functions globally available
          window.testSelectColor = testSelectColor;
          window.testSubPalette = testSubPalette;
          window.randomizePalette = randomizePalette;
          window.grayscalePalette = grayscalePalette;
          window.clearLog = clearLog;

          // Initial display update
          updateSelectedColorDisplay();

          logEvent("PaletteEditor initialized with MVC architecture");
          console.log("PaletteEditor test page ready");
        } catch (error) {
          statusDiv.className = "status error";
          statusDiv.textContent = `âœ— Failed to initialize: ${error.message}`;
          console.error("Initialization error:", error);
        }
      }

      function setupDefaultPalette() {
        // Sub-palette 0: Basic colors
        const palette0 = [
          { r: 0, g: 0, b: 0 }, // 0: Black (transparent)
          { r: 255, g: 255, b: 255 }, // 1: White
          { r: 255, g: 0, b: 0 }, // 2: Red
          { r: 0, g: 255, b: 0 }, // 3: Green
          { r: 0, g: 0, b: 255 }, // 4: Blue
          { r: 255, g: 255, b: 0 }, // 5: Yellow
          { r: 255, g: 0, b: 255 }, // 6: Magenta
          { r: 0, g: 255, b: 255 }, // 7: Cyan
          { r: 128, g: 128, b: 128 }, // 8: Gray
          { r: 255, g: 128, b: 0 }, // 9: Orange
          { r: 128, g: 0, b: 255 }, // 10: Purple
          { r: 0, g: 128, b: 128 }, // 11: Teal
          { r: 128, g: 64, b: 0 }, // 12: Brown
          { r: 255, g: 192, b: 203 }, // 13: Pink
          { r: 64, g: 64, b: 64 }, // 14: Dark Gray
          { r: 192, g: 192, b: 192 }, // 15: Light Gray
        ];

        palette0.forEach((color, idx) => {
          paletteModel.setColor(0, idx, color.r, color.g, color.b);
        });

        // Sub-palette 1: Warm colors
        for (let i = 0; i < 16; i++) {
          const r = Math.floor(128 + (i / 15) * 127);
          const g = Math.floor((i / 15) * 128);
          const b = 0;
          paletteModel.setColor(1, i, r, g, b);
        }

        // Sub-palette 2: Cool colors
        for (let i = 0; i < 16; i++) {
          const r = 0;
          const g = Math.floor((i / 15) * 128);
          const b = Math.floor(128 + (i / 15) * 127);
          paletteModel.setColor(2, i, r, g, b);
        }

        paletteModel.selectColor(1);
      }

      function updateSelectedColorDisplay() {
        const subPalette = paletteModel.getActiveSubPalette();
        const colorIndex = paletteModel.getSelectedColorIndex();
        const color = paletteModel.getColor(subPalette, colorIndex);

        // Update color swatch
        const swatch = document.getElementById("selected-color-swatch");
        swatch.style.backgroundColor = `rgb(${color.r}, ${color.g}, ${color.b})`;

        // Update info
        document.getElementById("info-subpalette").textContent = subPalette;
        document.getElementById("info-color-index").textContent = colorIndex;
        document.getElementById(
          "info-rgb888"
        ).textContent = `${color.r}, ${color.g}, ${color.b}`;

        // Calculate RGB555 value
        const r5 = color.r >> 3;
        const g5 = color.g >> 3;
        const b5 = color.b >> 3;
        const rgb555 = (r5 << 10) | (g5 << 5) | b5;
        document.getElementById("info-rgb555").textContent = `0x${rgb555
          .toString(16)
          .toUpperCase()
          .padStart(4, "0")}`;
      }

      function testSelectColor(colorIndex) {
        paletteController.selectColor(colorIndex);
        logEvent(`Controller.selectColor(${colorIndex})`);
      }

      function testSubPalette(subPaletteIndex) {
        paletteController.setActiveSubPalette(subPaletteIndex);
        logEvent(`Controller.setActiveSubPalette(${subPaletteIndex})`);
      }

      function randomizePalette() {
        const subPalette = paletteModel.getActiveSubPalette();
        for (let i = 1; i < 16; i++) {
          // Skip color 0 (transparent)
          const r = Math.floor(Math.random() * 256);
          const g = Math.floor(Math.random() * 256);
          const b = Math.floor(Math.random() * 256);
          paletteModel.setColor(subPalette, i, r, g, b);
        }
        logEvent(`Randomized sub-palette ${subPalette}`);
      }

      function grayscalePalette() {
        const subPalette = paletteModel.getActiveSubPalette();
        for (let i = 0; i < 16; i++) {
          const gray = Math.floor((i / 15) * 255);
          paletteModel.setColor(subPalette, i, gray, gray, gray);
        }
        logEvent(`Applied grayscale to sub-palette ${subPalette}`);
      }

      function logEvent(message) {
        const logDiv = document.getElementById("event-log");
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;

        // Limit log to 50 entries
        while (logDiv.children.length > 50) {
          logDiv.removeChild(logDiv.firstChild);
        }
      }

      function clearLog() {
        document.getElementById("event-log").innerHTML = "";
      }

      // Initialize on page load
      init();
    </script>
  </body>
</html>
